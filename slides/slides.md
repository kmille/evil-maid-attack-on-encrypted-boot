---
type: slide
slideOptions:
  transition: slide
  controls: true
  progress: true
  center: false
  title: Implementing evil maid attack on encrypted /boot
---
# Implementing evil maid attack on encrypted /boot

---

### PoC: Implementing evil maid attack on encrypted /boot

GPN20
19.05.2022
kmille

---

### Agenda
1) Understanding the boot process/grub
2) evil maid attack on unencrypted /boot
3) evil maid attack on encrypted /boot

---

### What this is about and what not
- Linux, BIOS, MBR, grub2 2.04, LUKS
- not: other OS, GPT, UEFI

---

### Definition

An evil maid attack is an attack on an unattended device, in which an attacker with physical access alters it in some undetectable way so that they can later access the device, or the data on it.

https://en.wikipedia.org/wiki/Evil_maid_attack

---

### The problem in fullscreen
- the code that asks you for the password
    - is not encrypted
    - is not signed
- an attacker can modify the code

---



### Motivation
- write a PoC as nobody did before
- learn about basic Linux stuff
- what happens during boot?

---

### 1) Understanding the boot process/grub


---


### High level overview: the boot process
1) BIOS loads bootloader (grub2)
2) grub2 loads and executes the Kernel/initrd
3) initrd mounts / and executes init system (systemd)
4) init system starts services (ssh)

---

### grub2 basics
- main goal: run the operating system
- limited space
- runs in multiple stages
- separates functionality in modules

---

![](https://md.darmstadt.ccc.de/uploads/53ed2908-58c0-44d1-8551-cee178130b78.svg)
https://upload.wikimedia.org/wikipedia/commons/1/18/GNU_GRUB_on_MBR_partitioned_hard_disk_drives.svg

---

![](https://md.darmstadt.ccc.de/uploads/42138c23-62cd-4b46-b2d6-98bf670275dd.png)

---

### 2) evil maid attack on unencrypted /boot

---

### Where does decryption takes place?
- stage 1 (boot.img)
- stage 1.5 (core.img)
- stage 2 (/boot) <- here (initrd contains cryptsetup binary)

---

### How to exploit
1) mount /boot partition
2) unpack initrd
3) backdoor it
4) rebuild initrd
5) overwrite initrd in /boot
6) during next boot, your code gets executed

---

### conclusion
- exploitation is very easy
- just modify a bash script
- https://github.com/nyxxxie/de-LUKS
- https://github.com/veggiedefender/luks_backdoor

---

### 3) evil maid attack on encrypted /boot

---


### 3) evil maid attack on encrypted /boot

- you can't just patch initrd
- but the problem remains
- the decryption code is still unencrypted and can be modified
- it's just harder to implement

---

### Where does decryption takes place?
- stage 1 (boot.img)
- stage 1.5 (core.img) <- somewhere here
- stage 2 (/boot) 

---

### Understanding core.img
- core.img is generated by grub-mkimage
- grub-install calls grub-mkimage
- git clone https://git.savannah.gnu.org/git/grub.git
- cd grub
- git checkout grub-2.04
- vim -p util/grub-mkimage.c util/mkimage.c

---

### structure of core.img
- core.img = concatenation of 
    - diskboot.img
    - lzma_decompress.img
    - compressed_stuff
- compressed_stuff = lzma_compressed:
    - kernel.img
    - struct grub_module_info32
    - modules
- module: type, size, content

---



### How to exploit
1) extract core.img
2) analyze it (find OS)
3) backdoor luks.mod
4) add disk.mod to write to disk
5) rebuild core.img
6) write core.img it to disk
7) during next boot, your code gets executed

---


### How to fix it?
- store grub2 on an external USB drive
- use UEFI with SecureBoot
    - https://github.com/kmille/cryptboot

---

### another learning
- Your system fails to boot?
- Just rebuild the broken stage!

---

### Thanks

- Code and slides: https://github.com/kmille/evil-maid-attack-on-encrypted-boot
- Q&A
- hello from the Internet o.o

---

